<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Yazming Clock</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root { --bg:#fff; --text:#ffd1e8; --glow: rgba(255,182,213,.9); }
[data-theme="dark"] { --bg:#0b0b0b; --text:#ff8fc7; --glow: rgba(255,143,199,.9); }

body{ margin:0; background:var(--bg); display:flex; justify-content:center; align-items:center; height:100vh; }
.widget{ font-family:'Press Start 2P', monospace; color:var(--text); text-align:center; animation:flicker 2.8s infinite; width:min(520px, 92vw); }
.time{ font-size:44px; text-shadow:0 0 6px var(--glow); }
.ampm{ font-size:10px; opacity:.6; }
.divider{ border-top:2px dashed currentColor; margin:12px 0; opacity:.6; }
.info{ font-size:11px; line-height:1.7; }
.controls{ font-size:10px; opacity:.6; cursor:pointer; margin-top:8px; user-select:none; }
.row{ display:flex; gap:8px; justify-content:center; align-items:center; margin-top:10px; flex-wrap:wrap; }

input{
  font-family:'Press Start 2P', monospace;
  font-size:10px;
  padding:8px 10px;
  border:2px dashed currentColor;
  background:transparent;
  color:var(--text);
  outline:none;
  width:min(260px, 72vw);
}
button{
  font-family:'Press Start 2P', monospace;
  font-size:10px;
  padding:8px 10px;
  border:2px dashed currentColor;
  background:transparent;
  color:var(--text);
  cursor:pointer;
}
button:active{ transform: translateY(1px); }

.small{ font-size:9px; opacity:.55; margin-top:8px; }

@keyframes flicker{ 0%{opacity:1} 6%{opacity:.85} 12%{opacity:1} 100%{opacity:1} }
</style>
</head>

<body>
<div class="widget">
  <div class="time" id="time">10:09</div>
  <div class="ampm" id="ampm">AM</div>

  <div class="divider"></div>

  <div class="info" id="date">MON OCT 24</div>
  <div class="info" id="city">LOCATINGâ€¦</div>
  <div class="info" id="weather">--Â°</div>

  <div class="row">
    <input id="cityInput" placeholder="type a city (ex: Tampa, FL)" autocomplete="off" />
    <button id="setCityBtn">â™¡ set</button>
  </div>
  <div class="small" id="status">Tip: Notion may block GPSâ€”manual city always works.</div>

  <div class="divider"></div>

  <div class="info" style="opacity:.4;">YAZMING made this</div>
  <div class="controls" onclick="toggleTheme()">â™¡ theme</div>
  <div class="controls" onclick="toggleUnit()">â™¡ Â°F / Â°C</div>
</div>

<script>
let unit = "F";
let lastTempC = null;
let lastCode = null;
let lastCityLabel = null;

function toggleTheme(){
  document.documentElement.dataset.theme =
    document.documentElement.dataset.theme === "dark" ? "light" : "dark";
}

function toggleUnit(){
  unit = unit === "F" ? "C" : "F";
  updateWeatherDisplay();
}

function updateClock(){
  const now = new Date();
  const time = now.toLocaleTimeString([], { hour:"numeric", minute:"2-digit", hour12:true });
  const [t,p] = time.split(" ");
  document.getElementById("time").textContent = t;
  document.getElementById("ampm").textContent = p;
  document.getElementById("date").textContent = now.toDateString().toUpperCase().replace(",", "");
}
updateClock();
setInterval(updateClock, 1000);

const icons = { 0:"â˜€", 1:"ðŸŒ¤", 2:"â›…", 3:"â˜", 45:"ðŸŒ«", 48:"ðŸŒ«", 51:"ðŸŒ§", 61:"ðŸŒ§", 71:"â„", 95:"â›ˆ" };

function updateWeatherDisplay(){
  if(lastTempC == null) return;
  const temp = unit === "F" ? Math.round(lastTempC*9/5 + 32) : Math.round(lastTempC);
  document.getElementById("weather").textContent = `${icons[lastCode] || "â™¡"} ${temp}Â°${unit}`;
  if (lastCityLabel) document.getElementById("city").textContent = lastCityLabel.toUpperCase();
}

function setStatus(msg){
  document.getElementById("status").textContent = msg;
}

async function loadFromCoords(lat, lon, labelOverride=null){
  // City label
  if (!labelOverride){
    try{
      const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1`);
      const geo = await geoRes.json();
      labelOverride = geo?.results?.[0]?.name || "UNKNOWN";
    } catch {
      labelOverride = "UNKNOWN";
    }
  }
  lastCityLabel = labelOverride;

  // Weather
  const weatherRes = await fetch(
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`
  );
  const weather = await weatherRes.json();
  lastTempC = weather.current.temperature_2m;
  lastCode = weather.current.weather_code;
  updateWeatherDisplay();

  // Auto dark theme
  const hour = new Date().getHours();
  if (hour >= 18 || hour < 6 || lastCode >= 3) document.documentElement.dataset.theme = "dark";

  setStatus("Loaded: location + weather âœ“");
}

async function loadFromIP(){
  const ipRes = await fetch("https://ipapi.co/json/");
  const ip = await ipRes.json();
  if (!ip || ip.latitude == null || ip.longitude == null) throw new Error("IP location unavailable");
  const label = ip.city || ip.region || ip.country_name || "UNKNOWN";
  await loadFromCoords(ip.latitude, ip.longitude, label);
}

function loadAuto(){
  document.getElementById("city").textContent = "LOCATINGâ€¦";
  document.getElementById("weather").textContent = "--Â°";
  setStatus("Trying GPSâ€¦ (Notion may block it)");

  const geoTimeout = setTimeout(async () => {
    // If geolocation hangs (common in Notion), use IP fallback
    try {
      setStatus("GPS blockedâ€”using IP locationâ€¦");
      await loadFromIP();
    } catch {
      setStatus("Location blocked. Use manual city search â†“");
      document.getElementById("city").textContent = "LOCATION BLOCKED";
    }
  }, 2200);

  if (!navigator.geolocation){
    clearTimeout(geoTimeout);
    loadFromIP().catch(() => {
      setStatus("Location blocked. Use manual city search â†“");
      document.getElementById("city").textContent = "LOCATION BLOCKED";
    });
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      clearTimeout(geoTimeout);
      setStatus("GPS allowedâ€”loading weatherâ€¦");
      await loadFromCoords(pos.coords.latitude, pos.coords.longitude);
    },
    async () => {
      clearTimeout(geoTimeout);
      try {
        setStatus("GPS deniedâ€”using IP locationâ€¦");
        await loadFromIP();
      } catch {
        setStatus("Location blocked. Use manual city search â†“");
        document.getElementById("city").textContent = "LOCATION BLOCKED";
      }
    },
    { enableHighAccuracy:false, timeout:2000, maximumAge:600000 }
  );
}

/* ðŸ“ Manual city search (no API keys) */
async function setManualCity(query){
  if (!query || !query.trim()) return;
  setStatus(`Searching: "${query}"â€¦`);
  document.getElementById("city").textContent = "SEARCHINGâ€¦";
  document.getElementById("weather").textContent = "--Â°";

  // Forward geocode
  const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=en&format=json`;
  const res = await fetch(url);
  const data = await res.json();

  const r = data?.results?.[0];
  if (!r){
    setStatus("Not found. Try: City, State (ex: Tampa, FL)");
    document.getElementById("city").textContent = "NOT FOUND";
    return;
  }

  const label = [r.name, r.admin1, r.country].filter(Boolean).join(", ");
  await loadFromCoords(r.latitude, r.longitude, label);
}

document.getElementById("setCityBtn").addEventListener("click", () => {
  setManualCity(document.getElementById("cityInput").value);
});
document.getElementById("cityInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") setManualCity(e.target.value);
});

// Start
loadAuto();
</script>
</body>
</html>


